<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>本地双人飞行棋（单文件）</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#1e90ff;--muted:#94a3b8;}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef6;background:linear-gradient(180deg,#081225 0%, #081827 100%);}
    .wrap{max-width:1100px;margin:18px auto;padding:18px;background:rgba(255,255,255,0.02);border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}    
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{display:flex;gap:12px;align-items:center}
    h1{font-size:20px;margin:0}
    .version{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    input[type=file]{display:none}
    label.filebtn{background:#0b1220;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;cursor:pointer}
    .panel{display:flex;gap:18px}
    .left{flex:1}
    .right{width:300px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);}
    .board{display:grid;gap:6px;padding:12px;justify-content:center}
    .cell{width:64px;height:64px;border-radius:8px;background:linear-gradient(180deg,#082134,#052034);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:12px;color:#dbeafe;border:1px solid rgba(255,255,255,0.03);position:relative}
    .idx{position:absolute;top:4px;left:6px;font-size:10px;color:var(--muted)}
    .piece{width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:11px;color:#082034;font-weight:700}
    .p1{background:#f97316}
    .p2{background:#60a5fa}
    .controls-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    button{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .log{max-height:220px;overflow:auto;padding:8px;margin-top:8px;background:rgba(255,255,255,0.01);border-radius:8px;font-size:13px}
    .status{margin-top:8px}
    .highlight{box-shadow:0 0 0 3px rgba(96,165,250,0.12) inset}
    .jump{box-shadow:0 0 0 3px rgba(249,115,22,0.12) inset}
    small.note{display:block;color:var(--muted);margin-top:6px}
    footer{margin-top:12px;font-size:12px;color:var(--muted)}
    @media (max-width:900px){.board{grid-template-columns:repeat(auto-fit,minmax(48px,1fr))} .cell{width:48px;height:48px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>本地双人飞行棋（单文件 HTML）</h1>
        <div class="version">版本: <strong id="version">v1.0.0</strong></div>
      </div>
      <div class="controls">
        <label class="filebtn">加载本地 CSV 文件<input id="csvfile" type="file" accept="text/csv,text/plain"/></label>
        <button id="loadSample" class="secondary">加载示例棋盘</button>
        <button id="reset" class="secondary">重置游戏</button>
      </div>
    </header>

    <div class="panel">
      <div class="left">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <strong>棋盘</strong>
            <div class="status">当前玩家: <span id="currentPlayer">—</span></div>
          </div>
          <div id="boardWrap" class="board" style="margin-top:12px"></div>
          <small class="note">提示：CSV 每行对应一格，格式：内容,类型,目标（类型和目标可选）。例如：二十,jump,15</small>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>行动</strong>
          <div class="controls-row">
            <div>掷骰子: <span id="dice">-</span></div>
            <button id="rollBtn">掷骰子</button>
            <button id="endTurnBtn" class="secondary">结束回合</button>
          </div>
          <div id="moveOptions" style="margin-top:8px"></div>
          <div class="log" id="log"></div>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <strong>设置</strong>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
            <label>玩家1 棋子数量: <input id="p1count" type="number" min="1" value="1" style="width:60px;margin-left:8px"/></label>
            <label>玩家2 棋子数量: <input id="p2count" type="number" min="1" value="1" style="width:60px;margin-left:8px"/></label>
            <label><input id="needSix" type="checkbox"/> 是否需要掷出6点才能出发（默认：否）</label>
            <button id="applyPieces" class="secondary">应用棋子数量</button>
            <small class="note">说明：默认每位玩家1个棋子。棋子初始为家中（未上场）。上场规则由“是否需要6点”决定。</small>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>规则（已实现）</strong>
          <ul>
            <li>本地轮流操作（双人），无需登录。</li>
            <li>读取本地 CSV 作为棋盘（每行一格）。</li>
            <li>无吃子规则（多个棋子可同格）。</li>
            <li>支持 <code>jump</code> 类型：落在该格后跳到目标格（目标为 1 开始索引）。</li>
            <li>可自定义每位玩家棋子数。</li>
            <li>可选择是否需要掷 6 才能上场。</li>
          </ul>
        </div>

      </div>
    </div>

    <footer>
      <small>本页面单文件实现，可直接保存为 HTML 并放到 GitHub Pages 或本地打开（加载 CSV 请用页面左上角的“加载本地 CSV 文件”）。</small>
    </footer>
  </div>

<script>
/*
Sample CSV (第一列内容, 第二列类型可选, 第三列目标可选)
示例：
一
二
三
十,jump,5
...
*/

const VERSION = 'v1.0.0';
document.getElementById('version').textContent = VERSION;

let board = []; // array of {content,type,target}
let players = [ {pieces:[], color:'p1'}, {pieces:[], color:'p2'} ];
let currentPlayer = 0; // 0 or 1
let diceRoll = null;
let needSixToEnter = false;
let logEl = document.getElementById('log');
const boardWrap = document.getElementById('boardWrap');

function log(s){ const t = document.createElement('div'); t.textContent = s; logEl.prepend(t); }

function parseCSVText(text){
  const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(r=>r.length>0);
  const res = rows.map((r,i)=>{
    const parts = r.split(',').map(p=>p.trim());
    return {content: parts[0] || (''+(i+1)), type: parts[1] || '', target: parts[2] ? parseInt(parts[2],10) : null };
  });
  return res;
}

function renderBoard(){
  boardWrap.innerHTML = '';
  if(board.length===0){ boardWrap.innerHTML = '<div style="color:var(--muted);padding:12px">未加载棋盘 - 请加载 CSV 或 示例</div>'; return; }
  // create grid columns to approximate square-ish layout
  const cols = Math.min(12, Math.max(6, Math.ceil(Math.sqrt(board.length))));
  boardWrap.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;

  board.forEach((cell, idx)=>{
    const el = document.createElement('div'); el.className='cell'; el.dataset.idx = idx+1;
    const idxSpan = document.createElement('div'); idxSpan.className='idx'; idxSpan.textContent = idx+1; el.appendChild(idxSpan);
    const content = document.createElement('div'); content.textContent = cell.content || ''; content.style.textAlign='center'; el.appendChild(content);
    if(cell.type && cell.type.toLowerCase()==='jump'){ el.classList.add('jump'); const small = document.createElement('small'); small.textContent = 'J→'+(cell.target||'?'); small.style.marginTop='6px'; el.appendChild(small);}    
    // pieces
    const pcs = document.createElement('div'); pcs.style.display='flex'; pcs.style.gap='4px'; pcs.style.marginTop='6px';
    // find pieces on this cell
    players.forEach((pl, pi)=>{
      pl.pieces.forEach((p, pj)=>{
        if(p.pos === idx+1){ const badge = document.createElement('div'); badge.className='piece '+(pi===0? 'p1':'p2'); badge.textContent = (pj+1); badge.title = `P${pi+1}#${pj+1}`; pcs.appendChild(badge); }
      })
    })
    el.appendChild(pcs);
    boardWrap.appendChild(el);
  })
}

function resetGame(){
  players = [ {pieces:[] , color:'p1'}, {pieces:[], color:'p2'} ];
  const p1n = parseInt(document.getElementById('p1count').value||'1',10) || 1;
  const p2n = parseInt(document.getElementById('p2count').value||'1',10) || 1;
  for(let i=0;i<p1n;i++) players[0].pieces.push({pos:null});
  for(let i=0;i<p2n;i++) players[1].pieces.push({pos:null});
  currentPlayer = 0;
  diceRoll = null;
  document.getElementById('dice').textContent = '-';
  document.getElementById('currentPlayer').textContent = '玩家'+(currentPlayer+1);
  renderBoard();
  log('游戏已重置。');
}

function applyPieces(){ resetGame(); log('已应用棋子数量设置。'); }

function loadCSVFromFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{ board = parseCSVText(reader.result); renderBoard(); resetGame(); log('已加载 CSV，格数：'+board.length); }
    catch(e){ alert('CSV 解析失败：'+e.message); }
  }
  reader.readAsText(file, 'utf-8');
}

function loadSample(){
  const sample = [
    '起点', '一','二','三','四','五','六','七','八','九','十',
    '十一','十二','十三','十四','十五','十六','十七','十八','十九','二十,jump,15',
    '二十一','二十二','二十三','终点'
  ].join('\n');
  board = parseCSVText(sample); renderBoard(); resetGame(); log('已加载内置示例棋盘（共 '+board.length+' 格）');
}

function rollDice(){
  if(board.length===0){ alert('请先加载棋盘 CSV 或 示例。'); return; }
  const r = Math.floor(Math.random()*6)+1; diceRoll = r; document.getElementById('dice').textContent = r; log('玩家'+(currentPlayer+1)+' 掷出：'+r);
  showMoveOptions();
}

function showMoveOptions(){
  const container = document.getElementById('moveOptions'); container.innerHTML='';
  const pl = players[currentPlayer];
  pl.pieces.forEach((p, idx)=>{
    const btn = document.createElement('button'); btn.className='secondary'; btn.textContent = `移动 棋子 #${idx+1}`;
    btn.onclick = ()=>{ tryMovePiece(idx); };
    // check possible validity
    const valid = canMovePiece(currentPlayer, idx, diceRoll);
    if(!valid){ btn.disabled = true; btn.title = '不可移动'; }
    container.appendChild(btn);
  });
}

function canMovePiece(playerIdx, pieceIdx, step){
  const p = players[playerIdx].pieces[pieceIdx];
  // if piece at home (pos==null), need to check entering
  if(p.pos === null){ if(needSixToEnter){ return step===6; } else { return step>0; } }
  // piece on board -> check not beyond end
  const dest = p.pos + step;
  return dest <= board.length; // cannot move beyond final cell
}

function tryMovePiece(pieceIdx){
  const pl = players[currentPlayer];
  const piece = pl.pieces[pieceIdx];
  if(diceRoll===null){ alert('请先掷骰子。'); return; }
  if(!canMovePiece(currentPlayer, pieceIdx, diceRoll)){ alert('该棋子无法移动。'); return; }
  // move logic
  if(piece.pos === null){ // entering
    piece.pos = 1; log(`玩家${currentPlayer+1} 的棋子#${pieceIdx+1} 从家中上场，位置 1`);
  } else {
    piece.pos = piece.pos + diceRoll;
    log(`玩家${currentPlayer+1} 的棋子#${pieceIdx+1} 移动到 ${piece.pos}`);
  }
  // jump rule
  const cell = board[piece.pos -1];
  if(cell && cell.type && cell.type.toLowerCase()==='jump' && cell.target){
    const tgt = parseInt(cell.target,10);
    if(!isNaN(tgt) && tgt>=1 && tgt<=board.length){ log(`触发 jump：从 ${piece.pos} 跳到 ${tgt}`); piece.pos = tgt; }
  }
  // clear dice and advance turn
  diceRoll = null; document.getElementById('dice').textContent = '-';
  renderBoard();
  // check win condition: any piece at last cell
  if(piece.pos === board.length){ alert('玩家 '+(currentPlayer+1)+' 胜利！'); log('玩家 '+(currentPlayer+1)+' 到达终点并获胜。'); }
}

function endTurn(){ diceRoll = null; document.getElementById('dice').textContent='-'; currentPlayer = 1-currentPlayer; document.getElementById('currentPlayer').textContent='玩家'+(currentPlayer+1); document.getElementById('moveOptions').innerHTML=''; log('轮到 玩家'+(currentPlayer+1)); }

// wire events
document.getElementById('csvfile').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(f) loadCSVFromFile(f); });
document.getElementById('loadSample').addEventListener('click', loadSample);
document.getElementById('applyPieces').addEventListener('click', applyPieces);
document.getElementById('rollBtn').addEventListener('click', rollDice);
document.getElementById('endTurnBtn').addEventListener('click', endTurn);
document.getElementById('reset').addEventListener('click', ()=>{ if(confirm('确认重置游戏？')){ resetGame(); }});

// update needSix
document.getElementById('needSix').addEventListener('change',(e)=>{ needSixToEnter = e.target.checked; log('是否需要掷6点才能出发：'+needSixToEnter); });

// initial
renderBoard(); resetGame();

</script>
</body>
</html>
